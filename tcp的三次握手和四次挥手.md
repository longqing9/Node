---
title: tcp的三次握手和四次挥手
date: 2021-06-01 20:51:11
tags: [网络协议,tcp]
categories: "网络原理"
---

### 一、TCP/IP四层模型和OSI七层模型



为了增强通用性和兼容性，计算机网络都被设计成层次结构，每一层都遵守一定的规则。因此有了OSI这样的一个抽象的网络通信模型，按照这个标准试计算机网络系统可以互相连接起来。

####  OSI七层模型

**物理层：** 通过网线、光缆等这种无理方式将电脑连接起来，传输的数据是比特流；0101这种形式。

**数据链路层：** 将比特流封装成数据帧的格式，对0、1进行分组。电脑连接起来之后，数据都进过网卡传输。而网卡上定义了全世界唯一的MAC地址。然后通过广播的形式向局域网内所有的电脑发送数据，网卡根据数据中MAC地址是否是自己的来判断数据是否是发送给自己的。

**网络层：** 广播的形式效率太低，为了区分哪些MAC地址属于同一子网，网络层定义了IP和子网掩码，通过对IP和子网掩码进行 与 运算判断是否在同一子网内，在通过路由器和交换机进行传输，IP协议数据网络层的协议；

**传输层：** 每一个进程都对应唯一的端口号，进程中数据是通过端口号传输数据并建立通信；

**会话层：** 负责建立和断开连接；

**表示层:**  为了使数据能够被计算机解析，需要将数据转换成另一种格式，比如文字、图片等；

**应用层：** 最高层，面对用户，提供计算机网络与最终呈现给用户的界面；

#### TCP/IP四层模型

**数据链路层：** 也称为网络访问层、网络接口层。它包含了OSI模型的物理层和数据链路层，把电脑连接起来；

**网络层：** 也叫做IP层，处理IP数据包的传输、路由，建立主机间的通信；

**传输层：** 就是两台主机设备提供端到端的通信；

**应用层：** 包含OSI模型的会话层，表示层和应用层，提供了一些长用户的协议规范，比如FTP、SMPT、HTTP 等；

总结，就是物理层通过物理端把电脑连接起来，数据链路层则对比特流的数据进行分组，网络层来建立主机到主机的通信，传输层建立端口到端口的通信，应用层最终负责建立连接，数据格式转换，最终呈现给用户。

<img src="https://longqing9.gitee.io/blog/images/osi.jpg" style="zoom:80%;" />



#### TCP三次握手的过程

建立连接前server端需要监听端口，因此初始状态是listen；

1、client端建立连接，发送一个syn同步包，发送之后状态变成syn_sent；

2、server端收到syn之后，同意建立连接，返回一个ack响应，同时也会给客户端发送一个syn包，发送完成之后状态变为syn_rcvd;

3、client端收到server的ack之后，状态变为established，返回ack给客户端。server收到之后状态变为established，连接建立完成；

<img src="https://longqing9.gitee.io/blog/images/tcp3.jpg" style="zoom:50%;" />

#### TCP连接建立为什么是三次

因为TCP是双工传输模式，不区分客户端和服务端，连接的建立是双向的过程。

如果只有两次，无法做到双向建立的连接，从建立连接server回复的syn和ack和博那个成一次可看出不需要进行一次。

#### TCP的四次挥手

1、client端向server发送fin包，进入fin_wait_1状态，表示客户端已经没有数据要发送了；

2、server端收到之后，返回ack，进入到close_wait等待关闭状态，因为server端可能还没有发送完成数据；

3、等到server端数据都发送完毕之后，server端就像client端发送fin，进入到last_ack状态；

4、client收到ack之后，进入time_wait的状态，同时回复ack，server收到之后，直接进入到closed状态，连接关闭，但是client要等待2MSL（报文最大生存时间）的时间，才会进入closed状态。

<img src="https://longqing9.gitee.io/blog/images/tcp4.jpg" style="zoom:50%;" />

#### 等待2MSL的时间关闭的原因

1、为了保证连接的可靠关闭，如果server没有收到最后一个ack，那么就会重新发送fin。

2、为了避免端口号重用带来的数据混淆。如果客户端直接进入到closed状态，又有相同端口向server建立一个连接，上一次连接的部分数据在网络中延迟到达server，数据就可能发生混淆；

#### TCP是如何保证传输过程的可靠性

**校验和：** 发送方在发送数据之前计算校验和，接收方收到数据后同样计算，如果不一致，那么传输有误；

**确认应答，序列号：** TCP在进行数据传输时，对数据都进行了编号，接收方在接收到数据之后发送的ack中包含确认序列号；

**超时重传：** 如果发送方发送完数据在一定时间内没有接收到  数据接收方发送的ack，就会及重新发送数据；

**连接管理：** 三次握手和四次挥手的过程；

 